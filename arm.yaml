tosca_definitions_version: cloudify_dsl_1_3


imports:
  - http://cloudify.co/spec/cloudify/4.5.5/types.yaml
  - plugin:cloudify-azure-plugin?version=2.1.2
  - plugin:cloudify-utilities-plugin


inputs:

  azure_subscription_id:
    default: { get_secret: azure_subscription_id }

  azure_tenant_id:
    default: { get_secret: azure_tenant_id }

  azure_client_id:
    default: { get_secret: azure_client_id }

  azure_client_secret:
    default: { get_secret: azure_client_secret }

  azure_location:
    default: { get_secret: azure_location }

  image:
    description: Image information
    default:
      publisher: OpenLogic
      offer: CentOS
      sku: 7.6
      version: latest

  size:
    description: Name of Virtual Machine Size in Azure.
    default: Standard_B1s

  # network_deployment_name:
  #   default: azure-example-network
  #
  # use_existing_network_deployment:
  #   default: true

  resource_prefix:
    description: Prefix of every resource created at this deployment on Azure.
    default: { get_secret: resource_prefix }

  resource_suffix:
    description: Suffix of every resource created at this deployment on Azure.
    default: { get_secret: resource_suffix }

  name:
    type: string
    default: centosvm


dsl_definitions:

  azure_config: &azure_config
    subscription_id: { get_input: azure_subscription_id }
    tenant_id: { get_input: azure_tenant_id }
    client_id: { get_input: azure_client_id }
    client_secret: { get_input: azure_client_secret }


node_templates:

  # network_deployment:
  #   type: cloudify.nodes.DeploymentProxy
  #   properties:
  #     resource_config:
  #       blueprint:
  #         id: { get_input: network_deployment_name }
  #         blueprint_archive: https://github.com/cloudify-examples/azure-example-network/archive/master.zip
  #         main_file_name: simple-blueprint.yaml
  #         external_resource: { get_input: use_existing_network_deployment }
  #       deployment:
  #         id: { get_input: network_deployment_name }
  #         inputs:
  #           resource_prefix: { get_input: resource_prefix }
  #           resource_suffix: { get_input: resource_suffix }
  #         outputs:
  #           resource_group: resource_group_value
  #           virtual_network: virtual_network_value
  #           public_subnet: public_subnet_value
  #           private_subnet: private_subnet_value
  #         external_resource: { get_input: use_existing_network_deployment }

  vm:
    type: cloudify.azure.Deployment
    properties:
      name:
        concat:
          - { get_input: resource_prefix }
          - 'resource_group'
          - { get_input: resource_suffix }
      location: { get_input: azure_location }
      azure_config: *azure_config
      params:
        resourcePrefix: { get_input: resource_prefix }
        resourceSuffix: { get_input: resource_suffix }
        location: { get_input: azure_location }
        vmName: { get_input: name }
        vmSize: { get_input: size }
        # image: { get_input: image }
        adminUsername: centos
        adminPublicKey: { get_secret: agent_key_public }
      template_file: templates/arm.json


capabilities:
  vm_ip:
    value: { get_attribute: [vm, outputs, ip, value, ipConfigurations, 0, properties, privateIPAddress] }
  vm_public_ip:
    value: { get_attribute: [vm, outputs, public_ip, value, ipAddress] }
  private_key_content:
    value: { get_secret: agent_key_private }
